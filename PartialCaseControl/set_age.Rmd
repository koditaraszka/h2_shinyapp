---
title: "Partially Observed Case-Control: Set Age"
output: html_document
---

```{r, size = 'small'}
setage_partialcc = function(data, select, minAge, maxAge, informative){
  # select are the true cases, but observed as controls
  
  if(informative==1){
    
    meanAge = mean(minAge, maxAge)
    stdAge = (maxAge-minAge)/4
    quantAge = runif(length(data$Y), 0.025, 0.975)
    ages = qnorm(quantAge, meanAge, stdAge)
    return(ages)
    
  }
  
  liab = -1*data$liab #higher liability equals lower age
  real_cases = c(which(data$Y==1), select)
  qnorm_cases = qnorm(rank(data$liab[real_cases], ties.method = 'random')/(length(data$liab[real_cases])+1))
  
  controls = length(which(data$Y==0))
  cenStd = (maxAge-minAge)/4
  cenMean = mean(c(minAge, maxAge))
  controlQuants = runif(controls, 0.025, 0.975)
  cenAge = qnorm(controlQuants, cenMean, cenStd)
  
  minCase = abs(min(qnorm_cases))
  maxCase = abs(max(qnorm_cases))
  onsetStd = (maxAge-minAge)/(minCase + maxCase)
  onsetMean = mean(c(minAge, maxAge))
  onsetAge = onsetMean + qnorm_cases*onsetStd
    
  age = rep(0, length(data$Y))
  age[which(data$Y==0)] = round(cenAge, 0)
  age[which(data$Y==1)] = round(onsetAge, 0)
  for(i in select){
    # since these people are unobserved, their age is < age of onset
    age[i] = round(runif(1, min=minAge, max=(age[i]-1)), 0) 
  }
  return(age)
  
}
```